
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“Š ãƒªã‚¯ãƒ«ãƒ¼ãƒˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆç·å—æ—¥å ±</title>
    
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <style>
        body { 
            font-family: 'Hiragino Sans', 'Hiragino Mincho ProN', 'Yu Gothic', 'Meiryo', 'DejaVu Sans', sans-serif;
            margin: 0; padding: 20px; background-color: #f8f9fa; 
        }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { 
            background: linear-gradient(135deg, #4A90E2 0%, #357ABD 50%, #1E3A8A 100%);
            color: white; padding: 15px 20px; border-radius: 8px 8px 0 0; position: relative;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .header-content { display: flex; align-items: center; justify-content: space-between; }
        .header-left { display: flex; align-items: center; }
        .header-icon { 
            width: 32px; height: 32px; background: rgba(255,255,255,0.2); 
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            margin-right: 12px; font-size: 16px;
        }
        .header-text h1 { 
            margin: 0; font-size: 20px; font-weight: 600; 
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .header-text .date { 
            font-size: 12px; font-weight: 400; margin-top: 2px; opacity: 0.9;
        }
        .header-right { display: flex; align-items: center; gap: 8px; }
        .update-button { 
            background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3);
            color: white; padding: 6px 10px; border-radius: 4px; text-decoration: none;
            font-size: 11px; font-weight: 500; transition: all 0.3s ease;
            cursor: pointer; opacity: 0.8; display: flex; align-items: center; gap: 4px;
        }
        .update-button:hover { background: rgba(255,255,255,0.25); opacity: 1; }
        .update-button:disabled { opacity: 0.5; cursor: not-allowed; }
        .update-time { 
            font-size: 10px; opacity: 0.7; color: white;
            white-space: nowrap; display: flex; align-items: center; gap: 3px;
        }
        .status-indicator { 
            width: 6px; height: 6px; border-radius: 50%; display: inline-block;
        }
        .status-indicator.loading { background: #4FC3F7; animation: pulse 1.5s infinite; }
        .status-indicator.success { background: #4CAF50; }
        .status-indicator.error { background: #f44336; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .header .generated { 
            font-size: 10px; opacity: 0.6; margin-top: 4px;
            position: absolute; bottom: 8px; right: 20px;
        }
        .content { padding: 25px; }
        .section-title { 
            font-size: 18px; font-weight: bold; margin: 25px 0 15px 0; 
            padding-left: 10px; border-left: 4px solid #667eea; color: #333;
        }
        
        /* Chart.jsç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .charts-section { margin: 25px 0; }
        .chart-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin: 20px 0; }
        .chart-grid-bottom { display: grid; grid-template-columns: 1fr; gap: 30px; margin: 20px 0; }
        .chart-container { 
            background: #fafafa; border-radius: 8px; padding: 20px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            overflow: hidden; /* ã¯ã¿å‡ºã—é˜²æ­¢ */
            min-width: 0; /* Flexbox shrinkingå¯¾å¿œ */
        }
        .chart-title { 
            font-size: 16px; font-weight: bold; margin-bottom: 15px; 
            text-align: center; color: #333;
        }
        .chart-canvas { 
            position: relative; 
            height: 300px; 
            width: 100%; 
            max-width: 100% !important; /* å¼·åˆ¶çš„ã«å¹…åˆ¶é™ */
            overflow: hidden;
        }
        .chart-canvas canvas {
            max-width: 100% !important; /* Canvasè¦ç´ ã‚‚å¹…åˆ¶é™ */
            height: auto !important;
        }
        
        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
        @media (max-width: 1024px) { 
            .chart-grid { grid-template-columns: 1fr; }
            .chart-grid-bottom { grid-template-columns: 1fr; }
            .chart-canvas { height: 250px; }
        }
        
        /* ãƒ¢ãƒã‚¤ãƒ«å°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        @media (max-width: 768px) {
            body { padding: 5px; margin: 0; box-sizing: border-box; }
            .container { 
                border-radius: 4px; 
                width: 100%; 
                max-width: 100%;
                overflow-x: hidden; /* æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢ */
            }
            .header { padding: 12px 15px; }
            .header-content { align-items: center; }
            .header-left { min-width: 0; }
            .header-right { gap: 6px; }
            .header-icon { 
                width: 28px; height: 28px; font-size: 14px;
                margin-right: 8px;
            }
            .header-text h1 { font-size: 16px; }
            .header-text .date { font-size: 11px; }
            .update-button { padding: 5px 8px; font-size: 10px; }
            .update-time { font-size: 9px; }
            .content { 
                padding: 15px; 
                width: 100%;
                box-sizing: border-box;
                overflow-x: hidden;
            }
            .section-title { font-size: 16px; margin: 20px 0 10px 0; }
            .chart-canvas { 
                height: 220px; 
                width: 100% !important;
                max-width: calc(100vw - 70px) !important; /* viewportåŸºæº–ã®å¹…åˆ¶é™ */
            }
            .chart-container { 
                padding: 15px; 
                width: 100%;
                box-sizing: border-box;
                overflow: hidden;
            }
            .charts-section { 
                width: 100%;
                overflow-x: hidden;
            }
            .chart-grid { 
                gap: 15px; 
                width: 100%;
                overflow-x: hidden;
            }
            .chart-grid-bottom { 
                gap: 15px;
                width: 100%;
                overflow-x: hidden;
            }
            
            /* ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
            .kpi-table { font-size: 11px; }
            .kpi-table th, .kpi-table td { padding: 6px 4px; }
            .kpi-table th { font-size: 11px; }
            .kpi-table td { font-size: 11px; }
            .channel-desc { font-size: 10px; }
        }
        
        /* å°å‹ãƒ¢ãƒã‚¤ãƒ«å°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        @media (max-width: 480px) {
            body { padding: 2px; }
            .header { padding: 10px 12px; }
            .header-icon { 
                width: 24px; height: 24px; font-size: 12px;
                margin-right: 6px;
            }
            .header-text h1 { font-size: 14px; }
            .header-text .date { font-size: 10px; }
            .content { padding: 8px; }
            .chart-canvas { height: 200px; }
            .chart-container { padding: 8px; }
            .chart-title { font-size: 14px; }
            
            /* è¶…å°å‹ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
            .kpi-table { font-size: 10px; }
            .kpi-table th, .kpi-table td { padding: 4px 3px; }
            .kpi-table th { font-size: 10px; }
            .kpi-table td { font-size: 10px; }
            .channel-desc { display: none; } /* èª¬æ˜ã‚’éè¡¨ç¤º */
            
            /* ãƒ˜ãƒƒãƒ€ãƒ¼ãƒœã‚¿ãƒ³ã‚’ä¸‹ã«é…ç½® */
            .detail-button { 
                padding: 8px 16px; 
                font-size: 13px;
                margin-top: 10px;
            }
        }
        
        /* KPIãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
        .kpi-table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-bottom: 30px; 
            table-layout: fixed; 
        }
        .kpi-table th, .kpi-table td { 
            padding: 8px 6px; 
            text-align: center; 
            border: 1px solid #ddd; 
            word-wrap: break-word;
        }
        .kpi-table th { background-color: #495057; color: white; font-weight: bold; font-size: 13px; }
        .kpi-table td { background-color: #f8f9fa; font-size: 13px; }
        .kpi-table .metric { background-color: #ffffff; font-weight: bold; text-align: left; }
        .kpi-table .current { background-color: #fff3cd; font-weight: bold; font-size: 14px; }
        
        /* ç·å—æ•°å‹•å‘ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆ8åˆ—ï¼‰ã®åˆ—å¹… */
        .kpi-table.main-kpi th:nth-child(1) { width: 15%; }  /* æŒ‡æ¨™ */
        .kpi-table.main-kpi th:nth-child(2) { width: 13%; }  /* å½“æ—¥ */
        .kpi-table.main-kpi th:nth-child(3) { width: 13%; }  /* å‰æ—¥ */
        .kpi-table.main-kpi th:nth-child(4) { width: 12%; }  /* å‰æ—¥æ¯” */
        .kpi-table.main-kpi th:nth-child(5) { width: 13%; }  /* å‰é€±åŒæ—¥ */
        .kpi-table.main-kpi th:nth-child(6) { width: 12%; }  /* å‰é€±æ¯” */
        .kpi-table.main-kpi th:nth-child(7) { width: 13%; }  /* å‰å¹´åŒæ—¥ */
        .kpi-table.main-kpi th:nth-child(8) { width: 12%; }  /* å‰å¹´æ¯” */
        
        /* ãƒãƒ£ãƒãƒ«åˆ¥ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆ9åˆ—ï¼‰ã®åˆ—å¹… */
        .kpi-table.channel-table th:nth-child(1) { width: 18%; }  /* ãƒãƒ£ãƒãƒ« */
        .kpi-table.channel-table th:nth-child(2) { width: 11%; }  /* å½“æ—¥ */
        .kpi-table.channel-table th:nth-child(3) { width: 8%; }   /* ã‚·ã‚§ã‚¢ */
        .kpi-table.channel-table th:nth-child(4) { width: 11%; }  /* å‰æ—¥ */
        .kpi-table.channel-table th:nth-child(5) { width: 10%; }  /* å‰æ—¥æ¯” */
        .kpi-table.channel-table th:nth-child(6) { width: 11%; }  /* å‰é€±åŒæ—¥ */
        .kpi-table.channel-table th:nth-child(7) { width: 10%; }  /* å‰é€±æ¯” */
        .kpi-table.channel-table th:nth-child(8) { width: 11%; }  /* å‰å¹´åŒæ—¥ */
        .kpi-table.channel-table th:nth-child(9) { width: 10%; }  /* å‰å¹´æ¯” */
        .growth { font-weight: bold; }
        .growth.positive { color: #28a745; }
        .growth.negative { color: #dc3545; }
        
        /* ãƒãƒ£ãƒãƒ«èª¬æ˜ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .channel-name { font-weight: bold; color: #333; margin-bottom: 2px; }
        .channel-desc { 
            font-size: 11px; color: #6c757d; font-weight: normal; 
            line-height: 1.2; margin-top: 2px;
        }
        
        /* ãƒãƒ£ãƒãƒ«ã‚°ãƒ«ãƒ¼ãƒ—ã‚¹ã‚¿ã‚¤ãƒ« */
        .channel-group { margin-bottom: 25px; }
        .channel-group-header { 
            background: linear-gradient(135deg, #e9ecef, #dee2e6);
            color: #495057;
            padding: 8px 15px;
            border-radius: 6px 6px 0 0;
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 0;
            border-left: 4px solid #6c757d;
        }
        .detail-table { margin-top: 0; border-radius: 0 0 6px 6px; }
        
        /* ãƒãƒ£ãƒãƒ«è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ« - ã‚«ãƒ†ã‚´ãƒªãƒ˜ãƒƒãƒ€ãƒ¼ */
        .category-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-left: 4px solid #007bff;
        }
        
        .category-title {
            padding: 12px 16px !important;
            font-weight: bold;
            color: #495057;
            border-bottom: 1px solid #dee2e6 !important;
        }
        
        .category-divider {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .category-icon {
            color: #007bff;
            font-size: 12px;
        }
        
        /* ã‚µãƒ–ãƒãƒ£ãƒãƒ«è¡Œã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .sub-channel .channel-name {
            padding-left: 16px;
            font-size: 0.95em;
        }
        
        .footer { text-align: center; padding: 20px; color: #6c757d; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="header-left">
                    <div class="header-icon">ğŸ“Š</div>
                    <div class="header-text">
                        <h1>ç·å—æ—¥å ±</h1>
                        <div class="date" id="reportDate">èª­ã¿è¾¼ã¿ä¸­...</div>
                    </div>
                </div>
                <div class="header-right">
                    <div class="update-time" id="updateTime">
                        <span class="status-indicator success" id="statusIndicator"></span>
                        <span id="lastUpdateText">-</span>
                    </div>
                    <button class="update-button" id="updateButton" onclick="requestDataUpdate()">
                        <span id="updateButtonText">æ›´æ–°</span>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="content">
            <!-- Chart.js ã‚°ãƒ©ãƒ•ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section-title">ğŸ“Š ç·å—æ¨ç§»ã‚°ãƒ©ãƒ•</div>
            <div class="charts-section">
                <div class="chart-grid">
                    <div class="chart-container">
                        <div class="chart-title" id="daily-souke-title">ãƒ‡ã‚¤ãƒªãƒ¼ç·å—æ¨ç§»ï¼ˆä»Šæœˆ å¯¾å‰å¹´æ¯”è¼ƒï¼‰</div>
                        <div class="chart-canvas">
                            <canvas id="dailyChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title" id="cumulative-souke-title">ç´¯è¨ˆç·å—æ¨ç§»ï¼ˆä»Šæœˆ å¯¾å‰å¹´æ¯”è¼ƒï¼‰</div>
                        <div class="chart-canvas">
                            <canvas id="cumulativeChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="chart-grid-bottom">
                    <div class="chart-container">
                        <div class="chart-title" id="weekly-souke-title">é€±æ¬¡ç·å—æ¨ç§»ï¼ˆç›´è¿‘3ãƒ¶æœˆ å¯¾å‰å¹´æ¯”è¼ƒï¼‰</div>
                        <div class="chart-canvas">
                            <canvas id="weeklyChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- KPIãƒ†ãƒ¼ãƒ–ãƒ« -->
            <div class="section-title">ğŸ“ˆ ç·å—æ•°å‹•å‘</div>
            <table class="kpi-table main-kpi">
                <thead>
                    <tr>
                        <th>æŒ‡æ¨™</th>
                        <th>å½“æ—¥</th>
                        <th>å‰æ—¥</th>
                        <th>å‰æ—¥æ¯”</th>
                        <th>å‰é€±åŒæ—¥</th>
                        <th>å‰é€±æ¯”</th>
                        <th>å‰å¹´åŒæ—¥</th>
                        <th>å‰å¹´æ¯”</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="metric">ç·å—æ•°</td>
                        <td class="current" id="kpi-latest">èª­ã¿è¾¼ã¿ä¸­...</td>
                        <td id="kpi-prev-day">èª­ã¿è¾¼ã¿ä¸­...</td>
                        <td class="growth" id="kpi-day-growth">è¨ˆç®—ä¸­...</td>
                        <td id="kpi-prev-week">èª­ã¿è¾¼ã¿ä¸­...</td>
                        <td class="growth" id="kpi-week-growth">è¨ˆç®—ä¸­...</td>
                        <td id="kpi-prev-year">èª­ã¿è¾¼ã¿ä¸­...</td>
                        <td class="growth" id="kpi-year-growth">è¨ˆç®—ä¸­...</td>
                    </tr>
                </tbody>
            </table>
            
            <!-- ãƒãƒ£ãƒãƒ«åˆ¥å®Ÿç¸¾ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆå¤§åˆ†é¡ï¼‰ -->
            
            <div class="section-title">ğŸ“Š æµå…¥ãƒãƒ£ãƒãƒ«åˆ¥å®Ÿç¸¾ï¼ˆå¤§åˆ†é¡ï¼‰</div>
            <table class="kpi-table channel-table" id="channel-overview-table">
                <thead>
                    <tr>
                        <th>ãƒãƒ£ãƒãƒ«</th>
                        <th>å½“æ—¥</th>
                        <th>ã‚·ã‚§ã‚¢</th>
                        <th>å‰æ—¥</th>
                        <th>å‰æ—¥æ¯”</th>
                        <th>å‰é€±åŒæ—¥</th>
                        <th>å‰é€±æ¯”</th>
                        <th>å‰å¹´åŒæ—¥</th>
                        <th>å‰å¹´æ¯”</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="metric">
                            <div class="channel-name">èª­ã¿è¾¼ã¿ä¸­...</div>
                        </td>
                        <td class="current">-</td>
                        <td>-</td>
                        <td>-</td>
                        <td class="growth">-</td>
                        <td>-</td>
                        <td class="growth">-</td>
                        <td>-</td>
                        <td class="growth">-</td>
                    </tr>
                </tbody>
            </table>
            
            
            <!-- ãƒãƒ£ãƒãƒ«åˆ¥å®Ÿç¸¾ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆè©³ç´°åˆ†é¡ï¼‰ -->
            
            <div class="section-title">ğŸ“Š æµå…¥ãƒãƒ£ãƒãƒ«åˆ¥å®Ÿç¸¾ï¼ˆè©³ç´°åˆ†é¡ï¼‰</div>
            
            <table class="kpi-table channel-table detail-table" id="channel-detail-table">
                <thead>
                    <tr>
                        <th>ãƒãƒ£ãƒãƒ«</th>
                        <th>å½“æ—¥</th>
                        <th>ã‚·ã‚§ã‚¢</th>
                        <th>å‰æ—¥</th>
                        <th>å‰æ—¥æ¯”</th>
                        <th>å‰é€±åŒæ—¥</th>
                        <th>å‰é€±æ¯”</th>
                        <th>å‰å¹´åŒæ—¥</th>
                        <th>å‰å¹´æ¯”</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="metric">
                            <div class="channel-name">èª­ã¿è¾¼ã¿ä¸­...</div>
                        </td>
                        <td class="current">-</td>
                        <td>-</td>
                        <td>-</td>
                        <td class="growth">-</td>
                        <td>-</td>
                        <td class="growth">-</td>
                        <td>-</td>
                        <td class="growth">-</td>
                    </tr>
                </tbody>
            </table>
            
            
        </div>
        
        <div class="footer">
            <div>ğŸ¤– Chart.jsç‰ˆè‡ªå‹•ç”Ÿæˆãƒ¬ãƒãƒ¼ãƒˆ | ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹: BigQuery dharma-dwh-rag</div>
        </div>
    </div>

    <script>
        // Chart.jsè¨­å®šãƒ‡ãƒ¼ã‚¿ï¼ˆçµ±åˆæ§‹é€ ï¼šå…¨ä½“ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã¨åŒã˜å½¢å¼ï¼‰
        let chartData = {
            souke: {
                daily: { '2024': [], '2025': [] },
                cumulative: { '2024': [], '2025': [] },
                weekly: { '2024': [], '2025': [] },
                metadata: {
                    lastUpdated: new Date().toISOString(),
                    dataSource: 'loading'
                }
            },
            metadata: {
                lastUpdated: new Date().toISOString(),
                dataSource: 'loading',
                recordCount: 0
            }
        };
        
        // åˆæœŸåŒ–çŠ¶æ…‹ãƒ•ãƒ©ã‚°
        let isInitialized = false;
        
        // ãƒ¢ãƒã‚¤ãƒ«åˆ¤å®šé–¢æ•°
        const isMobile = () => window.innerWidth <= 768;
        
        // iframeé€šä¿¡ç”¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚¹ãƒŠãƒ¼
        window.addEventListener('message', (event) => {
            // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: ã‚ªãƒªã‚¸ãƒ³ç¢ºèªï¼ˆæœ¬ç•ªç’°å¢ƒã§ã¯é©åˆ‡ãªã‚ªãƒªã‚¸ãƒ³ã‚’è¨­å®šï¼‰
            // if (event.origin !== 'https://your-domain.netlify.app') return;
            
            if (event.data && event.data.type === 'UPDATE_CHART_DATA') {
                console.log('ğŸ“Š Chart.js: Received chart data update');
                updateChartsWithNewData(event.data.data);
                
                // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—æ›´æ–°
                if (event.data.data.metadata && event.data.data.metadata.lastUpdated) {
                    updateTimestamp(event.data.data.metadata.lastUpdated);
                    updateHeaderTime(event.data.data.metadata.lastUpdated);
                }
            } else if (event.data && event.data.type === 'UPDATE_TABLE_DATA') {
                console.log('ğŸ“Š Received table data update from parent:', event.data.data);
                updateKpiTable(event.data.data);
                updateChannelOverviewTable(event.data.data);
                updateChannelDetailTable(event.data.data);
            } else if (event.data && event.data.type === 'UPDATE_STATUS') {
                console.log('ğŸ“Š Received status update from parent:', event.data.status);
                updateHeaderStatus(event.data.status);
            }
        });
        
        // ãƒãƒ£ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿æ›´æ–°é–¢æ•°
        function updateChartsWithNewData(newData) {
            try {
                // ã‚°ãƒ­ãƒ¼ãƒãƒ«chartDataã‚’æ›´æ–°
                chartData = newData;
                
                // ãƒ‡ãƒ¼ã‚¿ãŒæ­£ã—ããªã„å ´åˆã®ç·Šæ€¥åœæ­¢
                if (!chartData || !chartData.souke) {
                    console.error('âŒ Chart.js: CRITICAL - chartData.souke is missing! Cannot render charts.');
                    console.error('âŒ Chart.js: Received data structure:', chartData);
                    return;
                }
                isInitialized = true; // åˆæœŸåŒ–å®Œäº†ãƒãƒ¼ã‚¯
                
                // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’ç ´æ£„
                chartInstances.forEach((chart, index) => {
                    if (chart && typeof chart.destroy === 'function') {
                        chart.destroy();
                    }
                });
                chartInstances.length = 0; // é…åˆ—ã‚’ã‚¯ãƒªã‚¢
                
                // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã®chartDataã‚’æ›´æ–°
                window.chartData = newData;
                
                // ãƒãƒ£ãƒ¼ãƒˆã‚’å†åˆæœŸåŒ–
                initializeCharts();
                
                // æ›´æ–°æ™‚åˆ»ã‚’è¡¨ç¤ºæ›´æ–°
                updateTimestamp(newData.metadata?.lastUpdated);
                
                console.log('âœ… Charts updated successfully');
            } catch (error) {
                console.error('âŒ Failed to update charts:', error);
            }
        }
        
        // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—æ›´æ–°é–¢æ•°
        function updateTimestamp(lastUpdated) {
            const timestampElements = document.querySelectorAll('.generated');
            if (timestampElements.length > 0 && lastUpdated) {
                const updateTime = new Date(lastUpdated);
                const timeString = updateTime.toLocaleString('ja-JP', {
                    year: 'numeric',
                    month: '2-digit', 
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                timestampElements.forEach(elem => {
                    elem.textContent = `è‡ªå‹•ç”Ÿæˆãƒ¬ãƒãƒ¼ãƒˆï¼ˆæœ€çµ‚æ›´æ–°: ${timeString}ï¼‰`;
                });
            }
        }
        
        // å…±é€šã®Chart.jsè¨­å®šï¼ˆå¹´åº¦é‡ã­åˆã‚ã›ç”¨ã«categoryè»¸ä½¿ç”¨ï¼‰
        const commonOptions = {
            responsive: true,
            maintainAspectRatio: false,
            resizeDelay: 0, // ãƒªã‚µã‚¤ã‚ºé…å»¶ãªã—
            devicePixelRatio: window.devicePixelRatio || 1, // ãƒ‡ãƒã‚¤ã‚¹å¯¾å¿œ
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        font: {
                            family: 'Hiragino Sans',
                            size: isMobile() ? 10 : 12
                        },
                        padding: isMobile() ? 10 : 15,
                        usePointStyle: true
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    titleFont: { 
                        family: 'Hiragino Sans',
                        size: isMobile() ? 11 : 12 
                    },
                    bodyFont: { 
                        family: 'Hiragino Sans',
                        size: isMobile() ? 10 : 11 
                    },
                    padding: isMobile() ? 6 : 8
                }
            },
            scales: {
                x: {
                    type: 'category',  // time â†’ categoryã«å¤‰æ›´
                    ticks: {
                        font: { 
                            family: 'Hiragino Sans',
                            size: isMobile() ? 9 : 11
                        },
                        maxRotation: isMobile() ? 60 : 45,
                        minRotation: isMobile() ? 30 : 0,
                        maxTicksLimit: isMobile() ? 8 : 12
                    }
                },
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            if (isMobile() && value >= 1000) {
                                return (value / 1000).toFixed(1) + 'Kä»¶';
                            }
                            return value.toLocaleString() + 'ä»¶';
                        },
                        font: { 
                            family: 'Hiragino Sans',
                            size: isMobile() ? 9 : 11
                        },
                        maxTicksLimit: isMobile() ? 6 : 8
                    }
                }
            },
            interaction: {
                mode: 'nearest',
                axis: 'x',
                intersect: false
            }
        };

        // Chart.jsã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’æ ¼ç´ã™ã‚‹é…åˆ—
        const chartInstances = [];
        
        // ãƒãƒ£ãƒ¼ãƒˆåˆæœŸåŒ–é–¢æ•°ï¼ˆçµ±åˆãƒ‡ãƒ¼ã‚¿æ§‹é€ å¯¾å¿œï¼šå…¨ä½“ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã¨åŒã˜ï¼‰
        function initializeCharts() {
            
            // === ç·å—ã‚°ãƒ©ãƒ•ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆå…¨ä½“ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã‹ã‚‰ç§»æ¤ï¼‰===
            
            // ãƒ‡ã‚¤ãƒªãƒ¼ç·å—ãƒãƒ£ãƒ¼ãƒˆ
            try {
                const dailyCtx = document.getElementById('dailyChart').getContext('2d');
                
                const dailyChart = new Chart(dailyCtx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: '2025å¹´',
                        data: chartData.souke.daily['2025'],
                        borderColor: '#7B68EE',
                        backgroundColor: 'rgba(123, 104, 238, 0.1)',
                        tension: 0.2,
                        fill: false
                    }, {
                        label: '2024å¹´', 
                        data: chartData.souke.daily['2024'],
                        borderColor: '#ff7f0e',
                        backgroundColor: 'rgba(255, 127, 14, 0.1)',
                        borderDash: [5, 5],
                        tension: 0.2,
                        fill: false
                    }]
                },
                options: commonOptions
            });
            chartInstances.push(dailyChart);
            console.log('âœ… Chart.js: Daily chart created successfully');
            } catch (dailyError) {
                console.error('âŒ Chart.js: Failed to create daily chart:', dailyError);
            }

        // ç´¯è¨ˆç·å—ãƒãƒ£ãƒ¼ãƒˆ
        const cumulativeCtx = document.getElementById('cumulativeChart').getContext('2d');
        const cumulativeChart = new Chart(cumulativeCtx, {
            type: 'line',
            data: {
                datasets: [{
                    label: '2025å¹´ç´¯è¨ˆ',
                    data: chartData.souke.cumulative['2025'],
                    borderColor: '#7B68EE',
                    backgroundColor: 'rgba(123, 104, 238, 0.2)',
                    tension: 0.2,
                    fill: true
                }, {
                    label: '2024å¹´ç´¯è¨ˆ',
                    data: chartData.souke.cumulative['2024'],
                    borderColor: '#ff7f0e',
                    backgroundColor: 'rgba(255, 127, 14, 0.1)',
                    borderDash: [5, 5], 
                    tension: 0.2,
                    fill: true
                }]
            },
            options: commonOptions
        });
        chartInstances.push(cumulativeChart);

        // é€±æ¬¡ãƒãƒ£ãƒ¼ãƒˆï¼ˆæœªå®Œäº†é€±ã‚’ç‚¹ã®ã¿è¡¨ç¤ºï¼‰
        const weeklyCtx = document.getElementById('weeklyChart').getContext('2d');
        
        // 2025å¹´ãƒ‡ãƒ¼ã‚¿ã‚’å®Œäº†é€±ã¨æœªå®Œäº†é€±ã«åˆ†é›¢ï¼ˆçµ±åˆãƒ‡ãƒ¼ã‚¿æ§‹é€ å¯¾å¿œï¼‰
        let weekly2025Complete = [...chartData.souke.weekly['2025']];
        let weekly2025Current = null;
        
        // æœªå®Œäº†é€±ã‚’æ¤œå‡ºã—ã¦åˆ†é›¢
        const lastIndex = weekly2025Complete.length - 1;
        if (lastIndex >= 0 && weekly2025Complete[lastIndex].is_current_week) {
            weekly2025Current = weekly2025Complete.pop(); // æœ€å¾Œã®ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆã‚’å–ã‚Šé™¤ã
        }
        
        const weeklyDatasets = [{
            label: '2025å¹´ï¼ˆå®Œäº†é€±ï¼‰',
            data: weekly2025Complete,
            borderColor: '#7B68EE',
            backgroundColor: 'rgba(123, 104, 238, 0.2)',
            tension: 0.2,
            fill: false,
            spanGaps: false  // ç·šã®åˆ‡æ–­ã‚’è¨±å¯
        }, {
            label: '2024å¹´',
            data: chartData.souke.weekly['2024'], 
            borderColor: '#ff7f0e',
            backgroundColor: 'rgba(255, 127, 14, 0.2)',
            borderDash: [5, 5],
            tension: 0.2,
            fill: false
        }];
        
        // æœªå®Œäº†é€±ãŒã‚ã‚Œã°ç‚¹ã®ã¿è¡¨ç¤ºç”¨ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’è¿½åŠ 
        if (weekly2025Current) {
            weeklyDatasets.push({
                label: '2025å¹´ï¼ˆæœªå®Œäº†é€±ï¼‰',
                data: [weekly2025Current],
                borderColor: '#1f77b4',
                backgroundColor: '#1f77b4',
                pointRadius: 6,           // ç‚¹ã‚’å¤§ãã
                pointBorderWidth: 2,     // ç‚¹ã®å¢ƒç•Œç·šã‚’å¤ªã
                showLine: false,         // ç·šã‚’è¡¨ç¤ºã—ãªã„ï¼ˆç‚¹ã®ã¿ï¼‰
                fill: false
            });
        }
        
        const weeklyChart = new Chart(weeklyCtx, {
            type: 'line',
            data: {
                datasets: weeklyDatasets
            },
            options: commonOptions
        });
        chartInstances.push(weeklyChart);
        
        // å¢—åŠ ç‡è¨ˆç®—é–¢æ•°
        function calculateGrowthRate(current, previous) {
            if (previous === 0 || previous === null || previous === undefined) {
                return '-';
            }
            const rate = ((current - previous) / previous) * 100;
            return rate >= 0 ? `+${rate.toFixed(1)}%` : `${rate.toFixed(1)}%`;
        }

        // å‹•çš„ã«å¢—åŠ ç‡ã‚’è¨ˆç®—ãƒ»æ›´æ–°
        function updateGrowthRates() {
            // chartDataå­˜åœ¨ãƒã‚§ãƒƒã‚¯
            if (!chartData || !chartData.daily || !chartData.daily["2025"] || !chartData.daily["2024"]) {
                console.warn('chartData not properly initialized');
                return;
            }
            
            // æœ€æ–°æ—¥ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‹•çš„å–å¾—
            const latestData = chartData.daily["2025"];
            if (!latestData || latestData.length === 0) return;
            
            // æœ€æ–°æ—¥ï¼ˆãƒ‡ãƒ¼ã‚¿ã®æœ€å¾Œã®æ—¥ä»˜ï¼‰
            const currentDay = latestData[latestData.length - 1];
            const currentDate = currentDay.x; // "M/D"å½¢å¼
            
            // å‰æ—¥ãƒ»å‰é€±åŒæ—¥ãƒ»å‰å¹´åŒæ—¥ã‚’å‹•çš„è¨ˆç®—
            const [month, day] = currentDate.split('/').map(Number);
            const prevDayStr = day > 1 ? `${month}/${day-1}` : 
                              month > 1 ? `${month-1}/${new Date(2025, month-2, 0).getDate()}` : "12/31";
            const weekAgoStr = day > 7 ? `${month}/${day-7}` : 
                              month > 1 ? `${month-1}/${new Date(2025, month-2, 0).getDate()-(7-day)}` : null;
            
            const previousDay = chartData.daily["2025"].find(d => d.x === prevDayStr);
            const lastWeekSameDay = weekAgoStr ? chartData.daily["2025"].find(d => d.x === weekAgoStr) : null;
            const lastYearSameDay = chartData.daily["2024"].find(d => d.x === currentDate);

            if (currentDay && previousDay && lastWeekSameDay && lastYearSameDay) {
                // å‰æ—¥æ¯”
                const dayOverDayRate = calculateGrowthRate(currentDay.y, previousDay.y);
                const dayOverDayElement = document.getElementById('day-over-day-rate');
                if (dayOverDayElement) {
                    dayOverDayElement.innerHTML = dayOverDayRate;
                    dayOverDayElement.className = dayOverDayRate.startsWith('+') ? 'growth positive' : 
                                                 dayOverDayRate.startsWith('-') ? 'growth negative' : 'growth';
                }

                // å‰é€±æ¯”
                const weekOverWeekRate = calculateGrowthRate(currentDay.y, lastWeekSameDay.y);
                const weekOverWeekElement = document.getElementById('week-over-week-rate');
                if (weekOverWeekElement) {
                    weekOverWeekElement.innerHTML = weekOverWeekRate;
                    weekOverWeekElement.className = weekOverWeekRate.startsWith('+') ? 'growth positive' : 
                                                   weekOverWeekRate.startsWith('-') ? 'growth negative' : 'growth';
                }

                // å‰å¹´æ¯”
                const yearOverYearRate = calculateGrowthRate(currentDay.y, lastYearSameDay.y);
                const yearOverYearElement = document.getElementById('year-over-year-rate');
                if (yearOverYearElement) {
                    yearOverYearElement.innerHTML = yearOverYearRate;
                    yearOverYearElement.className = yearOverYearRate.startsWith('+') ? 'growth positive' : 
                                                   yearOverYearRate.startsWith('-') ? 'growth negative' : 'growth';
                }
            }
        }

        // è©³ç´°è¡¨ç¤ºæ©Ÿèƒ½ã¯å‰Šé™¤ï¼ˆã‚¹ãƒªãƒ åŒ–ã®ãŸã‚ï¼‰
        } // initializeChartsé–¢æ•°ã®çµ‚äº†
        
        // ãƒ˜ãƒƒãƒ€ãƒ¼ã®æ›´æ–°ãƒœã‚¿ãƒ³çŠ¶æ…‹ç®¡ç†
        function updateHeaderStatus(status) {
            const indicator = document.getElementById('statusIndicator');
            const button = document.getElementById('updateButton');
            const buttonText = document.getElementById('updateButtonText');
            
            if (!indicator || !button || !buttonText) return;
            
            // çŠ¶æ…‹ã«å¿œã˜ã¦ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã¨ãƒœã‚¿ãƒ³ã‚’æ›´æ–°
            indicator.className = 'status-indicator';
            
            switch (status) {
                case 'loading':
                    indicator.classList.add('loading');
                    button.disabled = true;
                    buttonText.textContent = 'æ›´æ–°ä¸­...';
                    break;
                case 'success':
                    indicator.classList.add('success');
                    button.disabled = false;
                    buttonText.textContent = 'æ›´æ–°';
                    break;
                case 'error':
                    indicator.classList.add('error');
                    button.disabled = false;
                    buttonText.textContent = 'æ›´æ–°';
                    break;
                default:
                    indicator.classList.add('success');
                    button.disabled = false;
                    buttonText.textContent = 'æ›´æ–°';
            }
        }
        
        // ãƒ˜ãƒƒãƒ€ãƒ¼ã®æ™‚é–“è¡¨ç¤ºæ›´æ–°
        function updateHeaderTime(timestamp) {
            const timeElement = document.getElementById('lastUpdateText');
            if (!timeElement || !timestamp) return;
            
            try {
                const updateTime = new Date(timestamp);
                const now = new Date();
                const diffMinutes = Math.floor((now - updateTime) / (1000 * 60));
                
                let timeText;
                if (diffMinutes < 1) {
                    timeText = 'ä»Š';
                } else if (diffMinutes < 60) {
                    timeText = `${diffMinutes}åˆ†å‰`;
                } else {
                    timeText = updateTime.toLocaleDateString('ja-JP', {
                        month: 'numeric',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                }
                
                timeElement.textContent = timeText;
            } catch (error) {
                console.warn('âš ï¸ Error updating header time:', error);
                timeElement.textContent = '-';
            }
        }
        
        // ãƒ‡ãƒ¼ã‚¿æ›´æ–°è¦æ±‚ã‚’è¦ªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«é€ä¿¡
        function requestDataUpdate() {
            console.log('ğŸ“¤ Requesting data update from iframe');
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({
                    type: 'REQUEST_DATA_UPDATE',
                    source: 'souke-report'
                }, '*');
            }
        }
        
        // åˆæœŸåŒ–å®Ÿè¡Œ
        initializeCharts();
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœã¨å‹•çš„è¨ˆç®—
        document.addEventListener('DOMContentLoaded', function() {
            const header = document.querySelector('.header');
            const content = document.querySelector('.content');
            
            header.style.opacity = '0';
            header.style.transform = 'translateY(-20px)';
            content.style.opacity = '0';
            content.style.transform = 'translateY(20px)';
            
            setTimeout(() => {
                header.style.transition = 'all 0.6s ease';
                content.style.transition = 'all 0.6s ease';
                header.style.opacity = '1';
                header.style.transform = 'translateY(0)';
                content.style.opacity = '1';
                content.style.transform = 'translateY(0)';
                
                // å‹•çš„ã«å¢—åŠ ç‡ã‚’è¨ˆç®—ãƒ»æ›´æ–°ï¼ˆå®‰å…¨å‘¼ã³å‡ºã—ï¼‰
                if (typeof updateGrowthRates === 'function') {
                    updateGrowthRates();
                } else {
                    console.warn('updateGrowthRates function not yet defined');
                }
                
                // Chart.jsã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åˆæœŸåŒ–å¾Œã®ãƒªã‚µã‚¤ã‚º
                setTimeout(() => {
                    forceChartResize();
                }, 500);
            }, 100);
        });
        
        // Chart.jsç”¨ã®ãƒªã‚µã‚¤ã‚ºå‡¦ç†é–¢æ•°
        function forceChartResize() {
            chartInstances.forEach((chart, index) => {
                if (chart && typeof chart.resize === 'function') {
                    try {
                        chart.resize();
                        console.log(`Chart ${index} resized successfully`);
                    } catch (error) {
                        console.warn(`Chart ${index} resize failed:`, error);
                    }
                }
            });
        }
        
        // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºæ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        window.addEventListener('resize', function() {
            clearTimeout(window.resizeTimer);
            window.resizeTimer = setTimeout(() => {
                forceChartResize();
            }, 200);
        });
        
        // ã‚ªãƒªã‚¨ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å¤‰æ›´æ™‚ã®å¯¾å¿œï¼ˆãƒ¢ãƒã‚¤ãƒ«ï¼‰
        window.addEventListener('orientationchange', function() {
            setTimeout(() => {
                forceChartResize();
            }, 600);
        });
        
        // Iframeèª­ã¿è¾¼ã¿å®Œäº†æ™‚ã®è¿½åŠ å‡¦ç†
        if (window.self !== window.top) { // iframeå†…ã§å®Ÿè¡Œä¸­
            window.addEventListener('message', function(event) {
                if (event.data === 'resize') {
                    setTimeout(() => {
                        forceChartResize();
                    }, 100);
                }
            });
        }
        
        function updateTimestamp(timestamp) {
            try {
                const updatedAt = new Date(timestamp);
                if (!isNaN(updatedAt.getTime())) {
                    const formattedTime = updatedAt.toLocaleString('ja-JP', {
                        timeZone: 'Asia/Tokyo',
                        year: 'numeric',
                        month: '2-digit', 
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                    
                    const timestampElement = document.querySelector('.timestamp-info');
                    if (timestampElement) {
                        timestampElement.textContent = `Last updated: ${formattedTime}`;
                    }
                    
                    console.log('ğŸ“… Timestamp updated:', formattedTime);
                } else {
                    console.warn('âš ï¸ Invalid timestamp format:', timestamp);
                }
            } catch (error) {
                console.error('âŒ Error updating timestamp:', error);
            }
        }
        
        // KPIãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°é–¢æ•°ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‡ãƒ¼ã‚¿å°‚ç”¨ï¼‰
        function updateKpiTable(tableData) {
            try {
                console.log('ğŸ“Š Starting KPI table update with data:', tableData);
                
                if (!tableData || !tableData.kpi) {
                    console.warn('âš ï¸ No KPI data provided');
                    return;
                }
                
                const kpiData = tableData.kpi;
                
                // æ•°å€¤ã‚’åƒã®ä½åŒºåˆ‡ã‚Šã§ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                const formatNumber = (num) => {
                    if (typeof num === 'number' && !isNaN(num)) {
                        return num.toLocaleString() + 'ä»¶';
                    }
                    return '0ä»¶';
                };
                
                // æˆé•·ç‡ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                const formatGrowthRate = (rate) => {
                    if (rate === null || rate === undefined || isNaN(rate)) {
                        return '-';
                    }
                    return (rate >= 0 ? '+' : '') + rate + '%';
                };
                
                // æˆé•·ç‡ã®CSSã‚¯ãƒ©ã‚¹å–å¾—
                const getGrowthClass = (rate) => {
                    if (rate === null || rate === undefined || isNaN(rate)) {
                        return '';
                    }
                    return rate > 0 ? 'positive' : (rate < 0 ? 'negative' : '');
                };
                
                // KPIæ•°å€¤ã‚’æ›´æ–°
                const updateElement = (id, value) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = value;
                        console.log(`âœ… Updated ${id}: ${value}`);
                    } else {
                        console.warn(`âš ï¸ Element ${id} not found`);
                    }
                };
                
                // åŸºæœ¬KPIå€¤ã®æ›´æ–°
                updateElement('kpi-latest', formatNumber(kpiData.latest_souke));
                updateElement('kpi-prev-day', formatNumber(kpiData.prev_day_souke));
                updateElement('kpi-prev-week', formatNumber(kpiData.prev_week_souke));
                updateElement('kpi-prev-year', formatNumber(kpiData.prev_year_souke));
                
                // æˆé•·ç‡ã®æ›´æ–°ï¼ˆã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨è¾¼ã¿ï¼‰
                const updateGrowthElement = (id, rate) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = formatGrowthRate(rate);
                        // æ—¢å­˜ã®ã‚¯ãƒ©ã‚¹ã‚’ã‚¯ãƒªã‚¢
                        element.classList.remove('positive', 'negative');
                        // æ–°ã—ã„ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
                        const growthClass = getGrowthClass(rate);
                        if (growthClass) {
                            element.classList.add(growthClass);
                        }
                        console.log(`âœ… Updated growth ${id}: ${formatGrowthRate(rate)} (class: ${growthClass})`);
                    } else {
                        console.warn(`âš ï¸ Growth element ${id} not found`);
                    }
                };
                
                updateGrowthElement('kpi-day-growth', kpiData.day_growth_rate);
                updateGrowthElement('kpi-week-growth', kpiData.week_growth_rate);
                updateGrowthElement('kpi-year-growth', kpiData.year_growth_rate);
                
                // ãƒ˜ãƒƒãƒ€ãƒ¼ã®æ—¥ä»˜æ›´æ–°ï¼ˆæœ€æ–°ãƒ‡ãƒ¼ã‚¿ã®æ—¥ä»˜ï¼‰
                if (kpiData.latest_date) {
                    const dateElement = document.querySelector('.header .date');
                    if (dateElement) {
                        try {
                            const date = new Date(kpiData.latest_date + 'T00:00:00');
                            const weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
                            const weekday = weekdays[date.getDay()];
                            const formattedDate = date.toLocaleDateString('ja-JP', {
                                year: 'numeric',
                                month: 'numeric',
                                day: 'numeric'
                            }) + `ï¼ˆ${weekday}ï¼‰`;
                            dateElement.textContent = formattedDate;
                            console.log(`âœ… Updated header date: ${formattedDate}`);
                        } catch (dateError) {
                            console.warn('âš ï¸ Date formatting error:', dateError);
                        }
                    }
                }
                
                // ç”Ÿæˆæ™‚åˆ»æ›´æ–°
                if (tableData.metadata && tableData.metadata.lastUpdated) {
                    const generatedElement = document.querySelector('.generated');
                    if (generatedElement) {
                        try {
                            const updatedAt = new Date(tableData.metadata.lastUpdated);
                            const formattedTime = updatedAt.toLocaleString('ja-JP', {
                                timeZone: 'Asia/Tokyo',
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit',
                                second: '2-digit'
                            });
                            generatedElement.textContent = `Generated at ${formattedTime}`;
                            console.log(`âœ… Updated generation time: ${formattedTime}`);
                        } catch (timeError) {
                            console.warn('âš ï¸ Time formatting error:', timeError);
                        }
                    }
                }
                
                console.log('âœ… KPI table update completed successfully');
                
            } catch (error) {
                console.error('âŒ Error updating KPI table:', error);
            }
        }
        
        // ãƒãƒ£ãƒãƒ«å¤§åˆ†é¡ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°é–¢æ•°
        function updateChannelOverviewTable(tableData) {
            try {
                console.log('ğŸ“Š Starting channel overview table update with data:', tableData);
                
                if (!tableData || !tableData.channels_overview) {
                    console.warn('âš ï¸ No channel overview data provided');
                    return;
                }
                
                const channelsData = tableData.channels_overview;
                console.log('ğŸ“Š Processing channels overview data:', channelsData);
                
                // æ•°å€¤ã‚’åƒã®ä½åŒºåˆ‡ã‚Šã§ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                const formatNumber = (num) => {
                    if (typeof num === 'number' && !isNaN(num)) {
                        return num.toLocaleString() + 'ä»¶';
                    }
                    return '0ä»¶';
                };
                
                // æˆé•·ç‡ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                const formatGrowthRate = (rate) => {
                    if (rate === null || rate === undefined || isNaN(rate)) {
                        return '-';
                    }
                    return (rate >= 0 ? '+' : '') + rate + '%';
                };
                
                // ã‚·ã‚§ã‚¢ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                const formatShare = (pct) => {
                    if (typeof pct === 'number' && !isNaN(pct)) {
                        return pct + '%';
                    }
                    return '0%';
                };
                
                // æˆé•·ç‡ã®CSSã‚¯ãƒ©ã‚¹å–å¾—
                const getGrowthClass = (rate) => {
                    if (rate === null || rate === undefined || isNaN(rate)) {
                        return '';
                    }
                    return rate > 0 ? 'positive' : (rate < 0 ? 'negative' : '');
                };
                
                // ãƒ†ãƒ¼ãƒ–ãƒ«æœ¬ä½“ã‚’å–å¾—
                const tableBody = document.querySelector('#channel-overview-table tbody');
                if (!tableBody) {
                    console.warn('âš ï¸ Channel overview table body not found');
                    return;
                }
                
                // ãƒ†ãƒ¼ãƒ–ãƒ«å†…å®¹ã‚’ã‚¯ãƒªã‚¢
                tableBody.innerHTML = '';
                
                // å„ãƒãƒ£ãƒãƒ«ã®è¡Œã‚’ä½œæˆ
                channelsData.forEach((channel, index) => {
                    const row = document.createElement('tr');
                    
                    const dayGrowthClass = getGrowthClass(channel.day_growth_rate);
                    const weekGrowthClass = getGrowthClass(channel.week_growth_rate);
                    const yearGrowthClass = getGrowthClass(channel.year_growth_rate);
                    
                    row.innerHTML = `
                        <td class="metric">
                            <div class="channel-name">${channel.channel_category}</div>
                        </td>
                        <td class="current">${formatNumber(channel.latest_souke)}</td>
                        <td>${formatShare(channel.share_pct)}</td>
                        <td>${formatNumber(channel.prev_day_souke)}</td>
                        <td class="growth ${dayGrowthClass}">${formatGrowthRate(channel.day_growth_rate)}</td>
                        <td>${formatNumber(channel.prev_week_souke)}</td>
                        <td class="growth ${weekGrowthClass}">${formatGrowthRate(channel.week_growth_rate)}</td>
                        <td>${formatNumber(channel.prev_year_souke)}</td>
                        <td class="growth ${yearGrowthClass}">${formatGrowthRate(channel.year_growth_rate)}</td>
                    `;
                    
                    tableBody.appendChild(row);
                    console.log(`âœ… Added channel overview row: ${channel.channel_category}`);
                });
                
                console.log('âœ… Channel overview table update completed successfully');
                
            } catch (error) {
                console.error('âŒ Error updating channel overview table:', error);
            }
        }
        
        // ãƒãƒ£ãƒãƒ«è©³ç´°åˆ†é¡ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°é–¢æ•°
        function updateChannelDetailTable(tableData) {
            try {
                console.log('ğŸ“Š Starting channel detail table update with data:', tableData);
                
                if (!tableData || !tableData.channels_detail) {
                    console.warn('âš ï¸ No channel detail data provided');
                    return;
                }
                
                const channelsData = tableData.channels_detail;
                console.log('ğŸ“Š Processing channels detail data:', channelsData);
                
                // æ•°å€¤ã‚’åƒã®ä½åŒºåˆ‡ã‚Šã§ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                const formatNumber = (num) => {
                    if (typeof num === 'number' && !isNaN(num)) {
                        return num.toLocaleString() + 'ä»¶';
                    }
                    return '0ä»¶';
                };
                
                // æˆé•·ç‡ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                const formatGrowthRate = (rate) => {
                    if (rate === null || rate === undefined || isNaN(rate)) {
                        return '-';
                    }
                    return (rate >= 0 ? '+' : '') + rate + '%';
                };
                
                // ã‚·ã‚§ã‚¢ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                const formatShare = (pct) => {
                    if (typeof pct === 'number' && !isNaN(pct)) {
                        return pct + '%';
                    }
                    return '0%';
                };
                
                // æˆé•·ç‡ã®CSSã‚¯ãƒ©ã‚¹å–å¾—
                const getGrowthClass = (rate) => {
                    if (rate === null || rate === undefined || isNaN(rate)) {
                        return '';
                    }
                    return rate > 0 ? 'positive' : (rate < 0 ? 'negative' : '');
                };
                
                // è¦ªã‚«ãƒ†ã‚´ãƒªåˆ¥ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
                const groupedChannels = {};
                channelsData.forEach(channel => {
                    const parent = channel.parent_category || 'ãã®ä»–ãƒ»ä¸æ˜';
                    if (!groupedChannels[parent]) {
                        groupedChannels[parent] = [];
                    }
                    groupedChannels[parent].push(channel);
                });
                
                // ãƒ†ãƒ¼ãƒ–ãƒ«æœ¬ä½“ã‚’å–å¾—
                const tableBody = document.querySelector('#channel-detail-table tbody');
                if (!tableBody) {
                    console.warn('âš ï¸ Channel detail table body not found');
                    return;
                }
                
                // ãƒ†ãƒ¼ãƒ–ãƒ«å†…å®¹ã‚’ã‚¯ãƒªã‚¢
                tableBody.innerHTML = '';
                
                // å„è¦ªã‚«ãƒ†ã‚´ãƒªã”ã¨ã«ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹ç¯‰
                const categoryOrder = ['æœ‰æ–™åºƒå‘Šæµå…¥', 'ã‚ªãƒ¼ã‚¬ãƒ‹ãƒƒã‚¯æµå…¥', 'ãã®ä»–ãƒ»ä¸æ˜'];
                
                categoryOrder.forEach(parentCategory => {
                    if (groupedChannels[parentCategory] && groupedChannels[parentCategory].length > 0) {
                        // ã‚«ãƒ†ã‚´ãƒªãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ä½œæˆ
                        const headerRow = document.createElement('tr');
                        headerRow.className = 'category-header';
                        headerRow.innerHTML = `
                            <td colspan="9" class="category-title">
                                <div class="category-divider">
                                    <span class="category-icon">â–¼</span>
                                    <strong>${parentCategory}</strong>
                                </div>
                            </td>
                        `;
                        tableBody.appendChild(headerRow);
                        
                        // å„ãƒãƒ£ãƒãƒ«è©³ç´°ã®è¡Œã‚’ä½œæˆ
                        groupedChannels[parentCategory].forEach((channel, index) => {
                            const row = document.createElement('tr');
                            
                            const dayGrowthClass = getGrowthClass(channel.day_growth_rate);
                            const weekGrowthClass = getGrowthClass(channel.week_growth_rate);
                            const yearGrowthClass = getGrowthClass(channel.year_growth_rate);
                            
                            row.innerHTML = `
                                <td class="metric sub-channel">
                                    <div class="channel-name">${channel.channel_category}</div>
                                </td>
                                <td class="current">${formatNumber(channel.latest_souke)}</td>
                                <td>${formatShare(channel.share_pct)}</td>
                                <td>${formatNumber(channel.prev_day_souke)}</td>
                                <td class="growth ${dayGrowthClass}">${formatGrowthRate(channel.day_growth_rate)}</td>
                                <td>${formatNumber(channel.prev_week_souke)}</td>
                                <td class="growth ${weekGrowthClass}">${formatGrowthRate(channel.week_growth_rate)}</td>
                                <td>${formatNumber(channel.prev_year_souke)}</td>
                                <td class="growth ${yearGrowthClass}">${formatGrowthRate(channel.year_growth_rate)}</td>
                            `;
                            
                            tableBody.appendChild(row);
                            console.log(`âœ… Added channel detail row: ${channel.channel_category} (${parentCategory})`);
                        });
                    }
                });
                
                console.log('âœ… Channel detail table update completed successfully');
                
            } catch (error) {
                console.error('âŒ Error updating channel detail table:', error);
            }
        }
    </script>
</body>
</html>
        